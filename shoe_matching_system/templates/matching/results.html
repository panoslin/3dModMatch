{% extends 'base.html' %}
{% load static %}

{% block title %}匹配结果 - 3D鞋模匹配系统{% endblock %}

{% block extra_css %}
<style>
    .result-card {
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 1.5rem;
    }
    
    .result-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.35rem 0.35rem 0 0;
    }
    
    .result-body {
        padding: 1.5rem;
    }
    
    .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fc;
    }
    
    .metric-item:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        font-weight: 600;
        color: #5a5c69;
    }
    
    .metric-value {
        font-weight: 700;
        color: #1cc88a;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .status-optimal {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-feasible {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-infeasible {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .comparison-table {
        background-color: #f8f9fc;
        border-radius: 0.35rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.35rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1cc88a;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #5a5c69;
        font-weight: 600;
    }
    
    .progress-bar {
        height: 0.5rem;
        background-color: #eaecf4;
        border-radius: 0.25rem;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #1cc88a 0%, #36e9e6 100%);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">匹配结果分析</h1>
        <div>
            <button class="btn btn-primary" onclick="refreshResults()">
                <i class="fas fa-sync-alt fa-sm"></i> 刷新结果
            </button>
            <a href="{% url 'core:upload' %}" class="btn btn-success">
                <i class="fas fa-upload fa-sm"></i> 上传新文件
            </a>
        </div>
    </div>

    <!-- 统计概览 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">匹配统计概览</h6>
                </div>
                <div class="card-body">
                    <div class="stats-grid" id="statsGrid">
                        <!-- 统计卡片将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 匹配结果列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">匹配结果列表</h6>
                    <div class="d-flex align-items-center">
                        <select class="form-control form-control-sm mr-2" id="filterStatus">
                            <option value="">所有状态</option>
                            <option value="optimal">最优匹配</option>
                            <option value="feasible">可行匹配</option>
                            <option value="infeasible">不可行</option>
                        </select>
                        <button class="btn btn-sm btn-outline-primary" onclick="applyFilters()">
                            <i class="fas fa-filter fa-sm"></i> 筛选
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="resultsContainer">
                        <!-- 结果列表将通过JavaScript动态加载 -->
                    </div>
                    
                    <!-- 分页控件 -->
                    <nav aria-label="匹配结果分页" id="paginationContainer">
                        <!-- 分页将通过JavaScript动态加载 -->
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 结果详情模态框 -->
<div class="modal fade" id="resultDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">匹配结果详情</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="resultDetailContent">
                <!-- 详情内容将通过JavaScript动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

// 页面加载完成后初始化
$(document).ready(function() {
    loadStats();
    loadResults();
    
    // 绑定筛选事件
    $('#filterStatus').change(function() {
        currentFilters.status = $(this).val();
        currentPage = 1;
        loadResults();
    });
});

// 加载统计信息
function loadStats() {
    $.ajax({
        url: '{% url "matching:get_stats" %}',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                displayStats(response.stats);
            } else {
                showAlert('加载统计信息失败: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('加载统计信息失败，请检查网络连接', 'danger');
        }
    });
}

// 显示统计信息
function displayStats(stats) {
    const statsGrid = $('#statsGrid');
    statsGrid.html(`
        <div class="stat-card">
            <div class="stat-number">${stats.total_results}</div>
            <div class="stat-label">总匹配数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${stats.optimal_results}</div>
            <div class="stat-label">最优匹配</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${stats.feasible_results.toFixed(0)}%</div>
            <div class="stat-label">成功率</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${stats.feasible_results}%"></div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${stats.utilization.average.toFixed(1)}%</div>
            <div class="stat-label">平均材料利用率</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${stats.margins.average.toFixed(1)}mm</div>
            <div class="stat-label">平均余量</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${stats.computation_time.average.toFixed(2)}s</div>
            <div class="stat-label">平均计算时间</div>
        </div>
    `);
}

// 加载匹配结果
function loadResults() {
    const params = new URLSearchParams({
        page: currentPage,
        page_size: 10,
        ...currentFilters
    });
    
    $.ajax({
        url: `{% url "matching:get_results" %}?${params}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                displayResults(response.results);
                displayPagination(response.pagination);
            } else {
                showAlert('加载匹配结果失败: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('加载匹配结果失败，请检查网络连接', 'danger');
        }
    });
}

// 显示匹配结果
function displayResults(results) {
    const container = $('#resultsContainer');
    
    if (results.length === 0) {
        container.html(`
            <div class="text-center py-4">
                <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                <p class="text-muted">暂无匹配结果</p>
            </div>
        `);
        return;
    }
    
    let html = '';
    results.forEach(function(result) {
        const statusClass = result.is_optimal ? 'status-optimal' : 
                           result.is_feasible ? 'status-feasible' : 'status-infeasible';
        const statusText = result.is_optimal ? '最优匹配' : 
                          result.is_feasible ? '可行匹配' : '不可行';
        
        html += `
            <div class="result-card">
                <div class="result-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${result.shoe_model.filename} → ${result.blank_model.filename}</h5>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                </div>
                <div class="result-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="metric-item">
                                <span class="metric-label">几何相似度:</span>
                                <span class="metric-value">${result.similarity_score.toFixed(1)}%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">材料利用率:</span>
                                <span class="metric-value">${result.material_utilization.toFixed(1)}%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">余量距离:</span>
                                <span class="metric-value">${result.margin_distance}mm</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-item">
                                <span class="metric-label">平均余量:</span>
                                <span class="metric-value">${result.average_margin.toFixed(1)}mm</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">最小余量:</span>
                                <span class="metric-value">${result.min_margin.toFixed(1)}mm</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">计算时间:</span>
                                <span class="metric-value">${result.computation_time.toFixed(2)}s</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-info" onclick="showResultDetail(${result.id})">
                            <i class="fas fa-eye fa-sm"></i> 查看详情
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteResult(${result.id})">
                            <i class="fas fa-trash fa-sm"></i> 删除
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
}

// 显示分页控件
function displayPagination(pagination) {
    const container = $('#paginationContainer');
    
    if (pagination.total_pages <= 1) {
        container.html('');
        return;
    }
    
    let html = '<ul class="pagination justify-content-center">';
    
    // 上一页
    if (pagination.has_previous) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${pagination.current_page - 1})">上一页</a></li>`;
    }
    
    // 页码
    for (let i = 1; i <= pagination.total_pages; i++) {
        if (i === pagination.current_page) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
        }
    }
    
    // 下一页
    if (pagination.has_next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${pagination.current_page + 1})">下一页</a></li>`;
    }
    
    html += '</ul>';
    container.html(html);
}

// 跳转到指定页面
function goToPage(page) {
    currentPage = page;
    loadResults();
}

// 应用筛选条件
function applyFilters() {
    currentPage = 1;
    loadResults();
}

// 显示结果详情
function showResultDetail(resultId) {
    // 这里可以通过API获取更详细的结果信息
    // 暂时显示基本信息
    $('#resultDetailModal').modal('show');
    $('#resultDetailContent').html(`
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2">加载详情中...</p>
        </div>
    `);
}

// 删除匹配结果
function deleteResult(resultId) {
    if (!confirm('确定要删除这个匹配结果吗？此操作不可恢复。')) {
        return;
    }
    
    $.ajax({
        url: `{% url "matching:delete_result" 0 %}`.replace('0', resultId),
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                showAlert('匹配结果删除成功', 'success');
                loadResults();
                loadStats();
            } else {
                showAlert('删除失败: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('删除失败，请检查网络连接', 'danger');
        }
    });
}

// 刷新结果
function refreshResults() {
    loadStats();
    loadResults();
}

// 显示提示信息
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `;
    
    // 在页面顶部显示提示
    $('.container-fluid').prepend(alertHtml);
    
    // 3秒后自动消失
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 3000);
}
</script>
{% endblock %}
