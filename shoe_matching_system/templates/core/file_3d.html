{% extends 'base.html' %}
{% load static %}

{% block title %}3D模型预览 - {{ file_obj.filename }} - 3D鞋模匹配系统{% endblock %}

{% block extra_css %}
<style>
    .model-viewer-container {
        position: relative;
        width: 100%;
        height: 600px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .model-info-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 20px;
        max-width: 300px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .controls-panel {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .control-group {
        display: flex;
        align-items: center;
        margin: 10px 0;
        gap: 10px;
    }
    
    .control-label {
        font-size: 12px;
        font-weight: bold;
        color: #495057;
        min-width: 60px;
    }
    
    .control-input {
        width: 100px;
        height: 30px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0 8px;
        font-size: 12px;
    }
    
    .view-mode-buttons {
        display: flex;
        gap: 5px;
        margin-top: 10px;
    }
    
    .view-mode-btn {
        padding: 5px 10px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .view-mode-btn:hover {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .view-mode-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .model-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 15px;
    }
    
    .stat-item {
        text-align: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .stat-value {
        font-size: 16px;
        font-weight: bold;
        color: #007bff;
    }
    
    .stat-label {
        font-size: 10px;
        color: #6c757d;
        text-transform: uppercase;
    }
    
    .error-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        max-width: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:home' %}">首页</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'core:file_list' %}">文件管理</a></li>
                    <li class="breadcrumb-item active">{{ file_obj.filename }}</li>
                </ol>
            </nav>
            
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-cube text-primary"></i>
                3D模型预览
            </h1>
            <p class="text-muted">{{ file_obj.filename }} - {{ file_type|title }}模型</p>
        </div>
    </div>

    <!-- 3D模型查看器 -->
    <div class="row">
        <div class="col-12">
            <div class="model-viewer-container" id="modelViewer">
                <!-- 加载覆盖层 -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    <p>正在加载3D模型...</p>
                </div>
                
                <!-- 错误消息 -->
                <div class="error-message" id="errorMessage" style="display: none;">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h5>模型加载失败</h5>
                    <p id="errorText">无法加载3D模型文件</p>
                    <button class="btn btn-primary mt-3" onclick="retryLoadModel()">重试</button>
                </div>
                
                <!-- 模型信息面板 -->
                <div class="model-info-panel">
                    <h6 class="mb-3">
                        <i class="fas fa-info-circle text-primary"></i>
                        模型信息
                    </h6>
                    
                    <div class="mb-3">
                        <strong>文件名:</strong><br>
                        <span class="text-primary">{{ file_obj.filename }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <strong>文件格式:</strong><br>
                        <span class="badge bg-secondary">{{ file_obj.file_format|upper }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <strong>文件大小:</strong><br>
                        <span class="text-muted">{{ file_obj.file_size|filesizeformat }}</span>
                    </div>
                    
                    {% if file_obj.bounds %}
                    <div class="model-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ file_obj.bounds.x_size|default:0|floatformat:1 }}</div>
                            <div class="stat-label">长度 (mm)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ file_obj.bounds.y_size|default:0|floatformat:1 }}</div>
                            <div class="stat-label">宽度 (mm)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ file_obj.bounds.z_size|default:0|floatformat:1 }}</div>
                            <div class="stat-label">高度 (mm)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ file_obj.volume|default:0|floatformat:1 }}</div>
                            <div class="stat-label">体积 (cm³)</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 控制面板 -->
                <div class="controls-panel">
                    <h6 class="mb-3">
                        <i class="fas fa-sliders-h text-success"></i>
                        视图控制
                    </h6>
                    
                    <div class="control-group">
                        <span class="control-label">缩放:</span>
                        <input type="range" class="control-input" id="zoomControl" min="0.1" max="5" step="0.1" value="1">
                    </div>
                    
                    <div class="control-group">
                        <span class="control-label">旋转:</span>
                        <input type="range" class="control-input" id="rotationControl" min="0" max="360" step="1" value="0">
                    </div>
                    
                    <div class="view-mode-buttons">
                        <button class="view-mode-btn active" onclick="setViewMode('solid')">实体</button>
                        <button class="view-mode-btn" onclick="setViewMode('wireframe')">线框</button>
                        <button class="view-mode-btn" onclick="setViewMode('points')">点云</button>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="resetView()">
                            <i class="fas fa-undo"></i> 重置视图
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                <a href="{% url 'core:file_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> 返回文件列表
                </a>
                
                {% if file_type == 'shoe' %}
                <a href="{% url 'core:matching' %}" class="btn btn-primary">
                    <i class="fas fa-magic"></i> 开始智能匹配
                </a>
                {% endif %}
                
                <button class="btn btn-outline-info" onclick="exportModel()">
                    <i class="fas fa-download"></i> 导出模型
                </button>
                
                <button class="btn btn-outline-success" onclick="takeScreenshot()">
                    <i class="fas fa-camera"></i> 截图
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script>
let scene, camera, renderer, controls;
let modelGroup, currentModel;
let isModelLoaded = false;

// 页面加载完成后初始化3D场景
document.addEventListener('DOMContentLoaded', function() {
    initialize3DScene();
    loadModel();
});

// 初始化3D场景
function initialize3DScene() {
    const container = document.getElementById('modelViewer');
    
    // 创建场景
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf5f7fa);
    
    // 创建相机
    camera = new THREE.PerspectiveCamera(
        75, 
        container.clientWidth / container.clientHeight, 
        0.1, 
        1000
    );
    camera.position.set(5, 5, 5);
    
    // 创建渲染器
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // 添加到容器
    container.appendChild(renderer.domElement);
    
    // 创建控制器
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    // 添加光源
    addLights();
    
    // 添加网格
    addGrid();
    
    // 创建模型组
    modelGroup = new THREE.Group();
    scene.add(modelGroup);
    
    // 开始渲染循环
    animate();
    
    // 监听窗口大小变化
    window.addEventListener('resize', onWindowResize);
}

// 添加光源
function addLights() {
    // 环境光
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);
    
    // 方向光
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 10, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    // 点光源
    const pointLight = new THREE.PointLight(0xffffff, 0.5);
    pointLight.position.set(-10, -10, -5);
    scene.add(pointLight);
}

// 添加网格
function addGrid() {
    const gridHelper = new THREE.GridHelper(20, 20, 0x888888, 0xcccccc);
    scene.add(gridHelper);
}

// 加载3D模型
function loadModel() {
    try {
        // 根据文件类型生成不同的3D模型
        if ('{{ file_obj.file_format }}' === '3dm') {
            loadRhinoModel();
        } else if ('{{ file_obj.file_format }}' === 'MOD') {
            loadModModel();
        } else {
            loadDefaultModel();
        }
    } catch (error) {
        console.error('模型加载失败:', error);
        showError('模型加载失败: ' + error.message);
    }
}

// 加载Rhino模型（简化版本）
function loadRhinoModel() {
    // 创建简化的鞋模几何体
    const geometry = new THREE.BoxGeometry(2, 1, 1);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x007bff,
        transparent: true,
        opacity: 0.8
    });
    
    currentModel = new THREE.Mesh(geometry, material);
    currentModel.castShadow = true;
    modelGroup.add(currentModel);
    
    hideLoading();
    isModelLoaded = true;
}

// 加载MOD模型（简化版本）
function loadModModel() {
    // 创建简化的粗胚几何体
    const geometry = new THREE.SphereGeometry(1.5, 32, 32);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x28a745,
        transparent: true,
        opacity: 0.8
    });
    
    currentModel = new THREE.Mesh(geometry, material);
    currentModel.castShadow = true;
    modelGroup.add(currentModel);
    
    hideLoading();
    isModelLoaded = true;
}

// 加载默认模型
function loadDefaultModel() {
    // 创建默认的立方体
    const geometry = new THREE.BoxGeometry(1, 1, 1);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x6c757d,
        transparent: true,
        opacity: 0.8
    });
    
    currentModel = new THREE.Mesh(geometry, material);
    currentModel.castShadow = true;
    modelGroup.add(currentModel);
    
    hideLoading();
    isModelLoaded = true;
}

// 隐藏加载覆盖层
function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// 显示错误消息
function showError(message) {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('errorText').textContent = message;
}

// 重试加载模型
function retryLoadModel() {
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // 清除现有模型
    if (currentModel) {
        modelGroup.remove(currentModel);
        currentModel = null;
    }
    
    // 重新加载
    setTimeout(loadModel, 1000);
}

// 设置视图模式
function setViewMode(mode) {
    if (!currentModel) return;
    
    // 更新按钮状态
    document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // 应用视图模式
    switch (mode) {
        case 'solid':
            currentModel.material.wireframe = false;
            currentModel.material.transparent = true;
            currentModel.material.opacity = 0.8;
            break;
        case 'wireframe':
            currentModel.material.wireframe = true;
            currentModel.material.transparent = false;
            break;
        case 'points':
            currentModel.material.wireframe = false;
            currentModel.material.transparent = false;
            break;
    }
}

// 重置视图
function resetView() {
    if (controls) {
        controls.reset();
    }
    
    if (currentModel) {
        currentModel.rotation.set(0, 0, 0);
        currentModel.scale.set(1, 1, 1);
    }
    
    // 重置控制滑块
    document.getElementById('zoomControl').value = 1;
    document.getElementById('rotationControl').value = 0;
}

// 导出模型
function exportModel() {
    if (!currentModel) {
        alert('没有可导出的模型');
        return;
    }
    
    // 这里可以实现模型导出功能
    alert('模型导出功能开发中...');
}

// 截图
function takeScreenshot() {
    if (!renderer) return;
    
    renderer.render(scene, camera);
    const dataURL = renderer.domElement.toDataURL('image/png');
    
    // 创建下载链接
    const link = document.createElement('a');
    link.download = '{{ file_obj.filename }}_screenshot.png';
    link.href = dataURL;
    link.click();
}

// 窗口大小变化处理
function onWindowResize() {
    const container = document.getElementById('modelViewer');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

// 渲染循环
function animate() {
    requestAnimationFrame(animate);
    
    if (controls) {
        controls.update();
    }
    
    // 处理控制滑块
    handleControls();
    
    renderer.render(scene, camera);
}

// 处理控制滑块
function handleControls() {
    const zoomControl = document.getElementById('zoomControl');
    const rotationControl = document.getElementById('rotationControl');
    
    if (zoomControl && currentModel) {
        const scale = parseFloat(zoomControl.value);
        currentModel.scale.set(scale, scale, scale);
    }
    
    if (rotationControl && currentModel) {
        const rotation = parseFloat(rotationControl.value) * Math.PI / 180;
        currentModel.rotation.y = rotation;
    }
}
</script>
{% endblock %}
