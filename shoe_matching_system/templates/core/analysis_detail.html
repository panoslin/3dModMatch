{% extends 'base.html' %}
{% load static %}

{% block title %}3Dæ™ºèƒ½åˆ†æ - {{ shoe_model.filename }}{% endblock %}

{% block extra_css %}
<style>
/* 3Dåˆ†æé¡µé¢æ ·å¼ */
.analysis-workspace {
    display: flex;
    height: calc(100vh - 60px);
    background: #1e1e1e;
}

/* å·¦ä¾§ç²—èƒšé€‰æ‹©å™¨ */
.blank-selector {
    width: 280px;
    background: #2c2c2c;
    color: white;
    border-right: 1px solid #444;
    overflow-y: auto;
}

.blank-selector-header {
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.blank-selector-header h4 {
    margin: 0 0 5px 0;
    font-size: 16px;
}

.blank-list {
    padding: 10px;
}

.blank-option {
    padding: 12px;
    margin-bottom: 8px;
    background: #3c3c3c;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.blank-option:hover {
    background: #4c4c4c;
    transform: translateX(5px);
}

.blank-option.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.blank-name {
    font-weight: 500;
    font-size: 14px;
}

.blank-metrics {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    font-size: 12px;
    opacity: 0.8;
}

/* ä¸­å¿ƒ3DæŸ¥çœ‹å™¨ */
.viewer-area {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.viewer-toolbar {
    background: #2c3e50;
    color: white;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-bottom: 1px solid #34495e;
}

.tool-group {
    display: flex;
    gap: 8px;
}

.tool-btn {
    background: #34495e;
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.tool-btn:hover {
    background: #4a6376;
    transform: translateY(-2px);
}

.tool-btn.active {
    background: #3498db;
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
}

.viewer-container {
    flex: 1;
    position: relative;
    background: linear-gradient(45deg, #2c3e50, #34495e);
    overflow: hidden;
}

.viewer-3d {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    flex-direction: column;
}

.viewer-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #34495e;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* çƒ­åŠ›å›¾å›¾ä¾‹ */
.heatmap-legend {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px;
    border-radius: 6px;
    font-size: 12px;
    backdrop-filter: blur(5px);
}

.legend-title {
    font-weight: bold;
    margin-bottom: 10px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 5px 0;
}

.legend-color {
    width: 20px;
    height: 12px;
    margin-right: 8px;
    border-radius: 2px;
}

/* æˆªé¢æ§åˆ¶å™¨ */
.cross-section-controls {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px;
    border-radius: 6px;
    backdrop-filter: blur(5px);
    display: none;
}

.cross-section-controls.active {
    display: block;
}

.control-group {
    margin: 10px 0;
}

.control-group label {
    display: block;
    font-size: 12px;
    margin-bottom: 5px;
}

.control-group input[type="range"] {
    width: 150px;
}

/* å³ä¾§åˆ†æé¢æ¿ */
.analysis-panel {
    width: 350px;
    background: white;
    border-left: 1px solid #e1e8ed;
    overflow-y: auto;
}

.panel-section {
    padding: 20px;
    border-bottom: 1px solid #e1e8ed;
}

.panel-section h5 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 16px;
}

/* åŒ¹é…ç»“æœå¡ç‰‡ */
.result-card {
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%);
    border: 1px solid #d1ecf1;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.result-badge {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.metric-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 15px;
}

.metric-item {
    text-align: center;
}

.metric-value {
    font-size: 18px;
    font-weight: bold;
    color: #2c3e50;
}

.metric-label {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 3px;
}

.utilization-score {
    color: #28a745;
}

.margin-warning {
    color: #f39c12;
}

.margin-danger {
    color: #e74c3c;
}

/* å‚æ•°è°ƒèŠ‚ */
.parameter-controls {
    background: #f8f9fa;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.param-group {
    margin: 15px 0;
}

.param-group label {
    display: block;
    font-size: 14px;
    margin-bottom: 8px;
    color: #2c3e50;
}

.param-range {
    width: 100%;
    margin: 5px 0;
}

.param-value {
    font-weight: bold;
    color: #3498db;
}

.param-group small {
    color: #7f8c8d;
    font-size: 12px;
}

/* å¤‡é€‰æ–¹æ¡ˆ */
.alternatives {
    margin-top: 20px;
}

.alternative-item {
    background: #f8f9fa;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.alternative-item:hover {
    background: #e8f4ff;
    border-color: #3498db;
    transform: translateY(-1px);
}

.alternative-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.alternative-metrics {
    display: flex;
    gap: 15px;
    margin-top: 8px;
    font-size: 12px;
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
    padding: 20px;
    background: #f8f9fa;
    display: flex;
    gap: 10px;
}

.btn-primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    flex: 1;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
}

.btn-secondary {
    background: #95a5a6;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: #7f8c8d;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1200px) {
    .blank-selector {
        width: 240px;
    }
    
    .analysis-panel {
        width: 300px;
    }
}

@media (max-width: 768px) {
    .analysis-workspace {
        flex-direction: column;
        height: auto;
    }
    
    .blank-selector {
        width: 100%;
        height: 120px;
    }
    
    .blank-list {
        display: flex;
        gap: 10px;
        overflow-x: auto;
    }
    
    .blank-option {
        min-width: 180px;
    }
    
    .analysis-panel {
        width: 100%;
        height: auto;
    }
    
    .viewer-area {
        height: 400px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analysis-workspace">
    <!-- å·¦ä¾§ç²—èƒšé€‰æ‹©å™¨ -->
    <div class="blank-selector">
        <div class="blank-selector-header">
            <h4>ğŸ“¦ é€‰æ‹©ç²—èƒš</h4>
            <div style="font-size: 12px; opacity: 0.9;">
                å…± {{ blank_models.count }} ä¸ªå¯é€‰
            </div>
        </div>
        
        <div class="blank-list">
            {% for blank in blank_models %}
            <div class="blank-option {% if forloop.first %}active{% endif %}" 
                 data-blank-id="{{ blank.id }}" 
                 onclick="selectBlank({{ blank.id }}, '{{ blank.filename }}')">
                <div class="blank-name">{{ blank.filename }}</div>
                <div class="blank-metrics">
                    <span>ä½“ç§¯: {% if blank.volume %}{{ blank.volume|floatformat:0 }}{% else %}--{% endif %}</span>
                    <span>
                        {% if optimal_match and optimal_match.blank_model.id == blank.id %}
                            ğŸ¥‡ æœ€ä¼˜
                        {% endif %}
                    </span>
                </div>
            </div>
            {% empty %}
            <div style="padding: 20px; text-align: center; color: #999;">
                æš‚æ— å¯ç”¨ç²—èƒš
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- ä¸­å¿ƒ3DæŸ¥çœ‹å™¨ -->
    <div class="viewer-area">
        <!-- å·¥å…·æ  -->
        <div class="viewer-toolbar">
            <div class="tool-group">
                <button class="tool-btn active" data-mode="rotate">
                    ğŸ® æ—‹è½¬
                </button>
                <button class="tool-btn" data-mode="heatmap">
                    ğŸ”¥ çƒ­åŠ›å›¾
                </button>
                <button class="tool-btn" data-mode="cross-section">
                    ğŸ“ æˆªé¢åˆ†æ
                </button>
                <button class="tool-btn" data-mode="animation">
                    ğŸ¬ åŠ¨ç”»æ¼”ç¤º
                </button>
            </div>
            
            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="tool-btn" onclick="resetView()">
                    ğŸ”„ é‡ç½®è§†è§’
                </button>
                <button class="tool-btn" onclick="captureScreenshot()">
                    ğŸ“· æˆªå›¾
                </button>
                <button class="tool-btn" onclick="saveAnalysis()">
                    ğŸ’¾ ä¿å­˜æ–¹æ¡ˆ
                </button>
            </div>
        </div>
        
        <!-- 3DæŸ¥çœ‹å™¨å®¹å™¨ -->
        <div class="viewer-container" id="viewer-container">
            <div class="viewer-3d">
                <div class="viewer-loading">
                    <div class="loading-spinner"></div>
                    <div>
                        <p>ğŸ® æ­£åœ¨åŠ è½½3Dæ¨¡å‹...</p>
                        <small>é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</small>
                    </div>
                </div>
            </div>
            
            <!-- çƒ­åŠ›å›¾å›¾ä¾‹ -->
            <div class="heatmap-legend" id="heatmap-legend" style="display: none;">
                <div class="legend-title">ä½™é‡çƒ­åŠ›å›¾</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>ä¸è¶³ (&lt; 2mm)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>ä¸´ç•Œ (2-3mm)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span>å……è¶³ (&gt; 3mm)</span>
                </div>
            </div>
            
            <!-- æˆªé¢æ§åˆ¶å™¨ -->
            <div class="cross-section-controls" id="cross-section-controls">
                <div class="control-group">
                    <label>æˆªé¢æ–¹å‘ï¼š</label>
                    <select id="section-plane">
                        <option value="xy">XYå¹³é¢</option>
                        <option value="xz">XZå¹³é¢</option>
                        <option value="yz">YZå¹³é¢</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ä½ç½®ï¼š<span id="section-position">50%</span></label>
                    <input type="range" id="section-slider" min="0" max="100" value="50">
                </div>
                <div class="control-group">
                    <button class="tool-btn" onclick="animateCrossSection()">ğŸ¬ åŠ¨ç”»åˆ‡ç‰‡</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§åˆ†æé¢æ¿ -->
    <div class="analysis-panel">
        <!-- é‹æ¨¡ä¿¡æ¯ -->
        <div class="panel-section">
            <h5>ğŸ‘Ÿ é‹æ¨¡ä¿¡æ¯</h5>
            <div>
                <strong>{{ shoe_model.filename }}</strong>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                æ–‡ä»¶æ ¼å¼: {{ shoe_model.file_format|upper }} | 
                {% if shoe_model.volume %}ä½“ç§¯: {{ shoe_model.volume|floatformat:0 }} mmÂ³{% endif %}
            </div>
        </div>
        
        <!-- åŒ¹é…ç»“æœ -->
        {% if optimal_match %}
        <div class="panel-section">
            <h5>ğŸ“Š æœ€ä¼˜åŒ¹é…ç»“æœ</h5>
            <div class="result-card" id="current-result">
                <div class="result-header">
                    <span><strong id="current-blank-name">{{ optimal_match.blank_model.filename }}</strong></span>
                    <span class="result-badge">ğŸ¥‡ æœ€ä¼˜</span>
                </div>
                
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value utilization-score" id="utilization-value">
                            {{ optimal_match.material_utilization|floatformat:1 }}%
                        </div>
                        <div class="metric-label">ææ–™åˆ©ç”¨ç‡</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avg-margin-value">
                            {{ optimal_match.average_margin|floatformat:1 }}mm
                        </div>
                        <div class="metric-label">å¹³å‡ä½™é‡</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value {% if optimal_match.min_margin < 2 %}margin-danger{% elif optimal_match.min_margin < 3 %}margin-warning{% endif %}" 
                             id="min-margin-value">
                            {{ optimal_match.min_margin|floatformat:1 }}mm
                        </div>
                        <div class="metric-label">æœ€å°ä½™é‡</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="similarity-value">
                            {{ optimal_match.similarity_score|floatformat:1 }}%
                        </div>
                        <div class="metric-label">å‡ ä½•ç›¸ä¼¼åº¦</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px;">
                        <span>é£é™©ç­‰çº§:</span>
                        <span id="risk-level" class="{% if optimal_match.min_margin >= 3 %}utilization-score{% elif optimal_match.min_margin >= 2 %}margin-warning{% else %}margin-danger{% endif %}">
                            {% if optimal_match.min_margin >= 3 %}ä½é£é™© âœ…{% elif optimal_match.min_margin >= 2 %}ä¸­é£é™© âš ï¸{% else %}é«˜é£é™© âŒ{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- å‚æ•°è°ƒèŠ‚ -->
        <div class="panel-section">
            <h5>âš™ï¸ åˆ†æå‚æ•°</h5>
            <div class="parameter-controls">
                <div class="param-group">
                    <label>ä½™é‡è·ç¦»: <span class="param-value" id="margin-value">{{ margin_distance }}</span>mm</label>
                    <input type="range" class="param-range" id="margin-slider" 
                           min="0.5" max="10" step="0.1" value="{{ margin_distance }}">
                    <small>è°ƒæ•´å®‰å…¨ä½™é‡è·ç¦»è¦æ±‚</small>
                </div>
                
                <div class="param-group">
                    <label>å‡ ä½•æƒé‡: <span class="param-value">40%</span></label>
                    <input type="range" class="param-range" min="0" max="100" value="40">
                    <small>å‡ ä½•ç›¸ä¼¼åº¦åœ¨åŒ¹é…ä¸­çš„æƒé‡</small>
                </div>
                
                <div class="param-group">
                    <label>æ•ˆç‡æƒé‡: <span class="param-value">20%</span></label>
                    <input type="range" class="param-range" min="0" max="100" value="20">
                    <small>ææ–™åˆ©ç”¨æ•ˆç‡çš„æƒé‡</small>
                </div>
                
                <button class="btn-primary" onclick="recalculateMatch()" style="width: 100%; margin-top: 10px;">
                    ğŸ”„ é‡æ–°è®¡ç®—
                </button>
            </div>
        </div>
        
        <!-- å¤‡é€‰æ–¹æ¡ˆ -->
        {% if matching_results %}
        <div class="panel-section">
            <h5>ğŸ”„ å¤‡é€‰æ–¹æ¡ˆ</h5>
            <div class="alternatives">
                {% for result in matching_results %}
                {% if not result.is_optimal %}
                <div class="alternative-item" onclick="selectAlternative({{ result.blank_model.id }})">
                    <div class="alternative-header">
                        <strong>{{ result.blank_model.filename }}</strong>
                        <span style="font-size: 12px; color: #666;">
                            {% if forloop.counter == 2 %}ğŸ¥ˆ{% elif forloop.counter == 3 %}ğŸ¥‰{% endif %}
                        </span>
                    </div>
                    <div class="alternative-metrics">
                        <span>åˆ©ç”¨ç‡: {{ result.material_utilization|floatformat:1 }}%</span>
                        <span>ä½™é‡: {{ result.average_margin|floatformat:1 }}mm</span>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button class="btn-primary" onclick="applyCurrentMatch()">
                âœ… åº”ç”¨æ–¹æ¡ˆ
            </button>
            <button class="btn-secondary" onclick="exportAnalysis()">
                ğŸ“Š å¯¼å‡ºæ•°æ®
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Three.js å’Œç›¸å…³3Dåº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
// å…¨å±€å˜é‡
let scene, camera, renderer, controls;
let shoeModel, blankModel;
let currentBlankId = {{ optimal_match.blank_model.id|default:"null" }};
let currentMode = 'rotate';
let heatmapData = [];

// åˆå§‹åŒ–3Dåœºæ™¯
function init3DScene() {
    const container = document.getElementById('viewer-container');
    
    // åœºæ™¯
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x2c3e50);
    
    // ç›¸æœº
    camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 0, 50);
    
    // æ¸²æŸ“å™¨
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // æ§åˆ¶å™¨
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    // ç¯å…‰
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(50, 50, 50);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    // æ›¿æ¢åŠ è½½ç•Œé¢
    container.innerHTML = '';
    container.appendChild(renderer.domElement);
    
    // å¼€å§‹æ¸²æŸ“å¾ªç¯
    animate();
    
    // åŠ è½½åˆå§‹æ¨¡å‹
    loadModels();
}

// åŠ¨ç”»å¾ªç¯
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// åŠ è½½3Dæ¨¡å‹ï¼ˆæ¨¡æ‹Ÿï¼‰
function loadModels() {
    // æ¨¡æ‹Ÿé‹æ¨¡ï¼ˆçº¢è‰²ç«‹æ–¹ä½“ï¼‰
    const shoeGeometry = new THREE.BoxGeometry(20, 10, 8);
    const shoeMaterial = new THREE.MeshLambertMaterial({ 
        color: 0xff6b6b, 
        transparent: true, 
        opacity: 0.8 
    });
    shoeModel = new THREE.Mesh(shoeGeometry, shoeMaterial);
    shoeModel.position.set(0, 0, 0);
    scene.add(shoeModel);
    
    // æ¨¡æ‹Ÿç²—èƒšï¼ˆè“è‰²ç«‹æ–¹ä½“ï¼Œç¨å¤§ï¼‰
    const blankGeometry = new THREE.BoxGeometry(25, 12, 10);
    const blankMaterial = new THREE.MeshLambertMaterial({ 
        color: 0x4ecdc4, 
        wireframe: true 
    });
    blankModel = new THREE.Mesh(blankGeometry, blankMaterial);
    blankModel.position.set(0, 0, 0);
    scene.add(blankModel);
}

// é€‰æ‹©ç²—èƒš
function selectBlank(blankId, blankName) {
    // æ›´æ–°UI
    document.querySelectorAll('.blank-option').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-blank-id="${blankId}"]`).classList.add('active');
    
    currentBlankId = blankId;
    document.getElementById('current-blank-name').textContent = blankName;
    
    // æ›´æ–°3Dæ¨¡å‹
    updateBlankModel(blankId);
    
    // è·å–æ–°çš„åˆ†ææ•°æ®
    loadAnalysisData({{ shoe_model.id }}, blankId);
}

// æ›´æ–°ç²—èƒšæ¨¡å‹
function updateBlankModel(blankId) {
    // è¿™é‡Œåº”è¯¥åŠ è½½çœŸå®çš„3Dæ¨¡å‹æ•°æ®
    // ç°åœ¨åªæ˜¯æ”¹å˜é¢œè‰²ä½œä¸ºæ¼”ç¤º
    const colors = [0x4ecdc4, 0x45b7c8, 0x96ceb4, 0xffeaa7, 0xdda0dd];
    const colorIndex = blankId % colors.length;
    blankModel.material.color.setHex(colors[colorIndex]);
}

// åŠ è½½åˆ†ææ•°æ®
async function loadAnalysisData(shoeId, blankId) {
    try {
        const response = await fetch(`{% url "core:api_analysis" 0 0 %}`.replace('0/0', `${shoeId}/${blankId}/`));
        const result = await response.json();
        
        if (result.success) {
            updateAnalysisDisplay(result.analysis);
        }
    } catch (error) {
        console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°åˆ†ææ˜¾ç¤º
function updateAnalysisDisplay(analysis) {
    const match = analysis.match_analysis;
    
    // æ›´æ–°æŒ‡æ ‡
    document.getElementById('utilization-value').textContent = match.material_utilization.toFixed(1) + '%';
    document.getElementById('avg-margin-value').textContent = match.average_margin.toFixed(1) + 'mm';
    document.getElementById('min-margin-value').textContent = match.min_margin.toFixed(1) + 'mm';
    document.getElementById('similarity-value').textContent = match.similarity_score.toFixed(1) + '%';
    
    // æ›´æ–°é£é™©ç­‰çº§
    const minMargin = match.min_margin;
    const riskElement = document.getElementById('risk-level');
    if (minMargin >= 3) {
        riskElement.textContent = 'ä½é£é™© âœ…';
        riskElement.className = 'utilization-score';
    } else if (minMargin >= 2) {
        riskElement.textContent = 'ä¸­é£é™© âš ï¸';
        riskElement.className = 'margin-warning';
    } else {
        riskElement.textContent = 'é«˜é£é™© âŒ';
        riskElement.className = 'margin-danger';
    }
    
    // æ›´æ–°çƒ­åŠ›å›¾æ•°æ®
    heatmapData = analysis.visualization_data.heatmap_data;
}

// å·¥å…·æ äº‹ä»¶å¤„ç†
document.querySelectorAll('.tool-btn[data-mode]').forEach(btn => {
    btn.addEventListener('click', function() {
        // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
        document.querySelectorAll('.tool-btn[data-mode]').forEach(b => b.classList.remove('active'));
        // æ·»åŠ å½“å‰activeçŠ¶æ€
        this.classList.add('active');
        
        const mode = this.getAttribute('data-mode');
        switchViewMode(mode);
    });
});

// åˆ‡æ¢æŸ¥çœ‹æ¨¡å¼
function switchViewMode(mode) {
    currentMode = mode;
    
    // éšè—æ‰€æœ‰æ§åˆ¶é¢æ¿
    document.getElementById('heatmap-legend').style.display = 'none';
    document.getElementById('cross-section-controls').style.display = 'none';
    
    switch (mode) {
        case 'rotate':
            // åŸºç¡€æ—‹è½¬æ¨¡å¼
            blankModel.material.wireframe = true;
            shoeModel.material.transparent = true;
            shoeModel.material.opacity = 0.8;
            break;
            
        case 'heatmap':
            // çƒ­åŠ›å›¾æ¨¡å¼
            document.getElementById('heatmap-legend').style.display = 'block';
            applyHeatmap();
            break;
            
        case 'cross-section':
            // æˆªé¢åˆ†ææ¨¡å¼
            document.getElementById('cross-section-controls').classList.add('active');
            break;
            
        case 'animation':
            // åŠ¨ç”»æ¼”ç¤ºæ¨¡å¼
            startMatchingAnimation();
            break;
    }
}

// åº”ç”¨çƒ­åŠ›å›¾
function applyHeatmap() {
    // è¿™é‡Œåº”è¯¥æ ¹æ®çœŸå®çš„çƒ­åŠ›å›¾æ•°æ®æ¥ç€è‰²
    // ç°åœ¨åªæ˜¯ç®€å•çš„æ¼”ç¤º
    const geometry = shoeModel.geometry;
    const colors = [];
    
    for (let i = 0; i < geometry.attributes.position.count; i++) {
        // æ¨¡æ‹Ÿçƒ­åŠ›å›¾é¢œè‰²
        const margin = Math.random() * 5; // æ¨¡æ‹Ÿä½™é‡å€¼
        if (margin < 2) {
            colors.push(0.9, 0.3, 0.3); // çº¢è‰² - ä¸è¶³
        } else if (margin < 3) {
            colors.push(0.9, 0.6, 0.1); // æ©™è‰² - ä¸´ç•Œ
        } else {
            colors.push(0.2, 0.8, 0.4); // ç»¿è‰² - å……è¶³
        }
    }
    
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
    shoeModel.material = new THREE.MeshLambertMaterial({ 
        vertexColors: true,
        transparent: true,
        opacity: 0.9
    });
}

// å¼€å§‹åŒ¹é…åŠ¨ç”»
function startMatchingAnimation() {
    // ç®€å•çš„è£…é…åŠ¨ç”»
    const originalPosition = blankModel.position.clone();
    blankModel.position.set(50, 0, 0);
    
    // åŠ¨ç”»ç§»åŠ¨åˆ°åŸä½ç½®
    const animate = () => {
        blankModel.position.lerp(originalPosition, 0.05);
        if (blankModel.position.distanceTo(originalPosition) > 0.1) {
            requestAnimationFrame(animate);
        }
    };
    animate();
}

// å‚æ•°è°ƒèŠ‚äº‹ä»¶
document.getElementById('margin-slider').addEventListener('input', function() {
    const value = parseFloat(this.value);
    document.getElementById('margin-value').textContent = value.toFixed(1);
});

// æˆªé¢æ§åˆ¶äº‹ä»¶
document.getElementById('section-slider').addEventListener('input', function() {
    const value = this.value;
    document.getElementById('section-position').textContent = value + '%';
    updateCrossSection(value);
});

// æ›´æ–°æˆªé¢
function updateCrossSection(position) {
    // è¿™é‡Œåº”è¯¥å®ç°çœŸæ­£çš„æˆªé¢åŠŸèƒ½
    console.log('æˆªé¢ä½ç½®:', position + '%');
}

// é‡æ–°è®¡ç®—åŒ¹é…
async function recalculateMatch() {
    const marginDistance = parseFloat(document.getElementById('margin-slider').value);
    
    try {
        const response = await fetch(`{% url "core:api_match" shoe_model.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                margin_distance: marginDistance,
                force_recalculate: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ›´æ–°æ˜¾ç¤º
            updateAnalysisDisplay({ match_analysis: result.result });
            alert('é‡æ–°è®¡ç®—å®Œæˆï¼');
        } else {
            alert('è®¡ç®—å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        alert('è®¡ç®—å‡ºé”™: ' + error.message);
    }
}

// å…¶ä»–åŠŸèƒ½å‡½æ•°
function resetView() {
    camera.position.set(0, 0, 50);
    controls.reset();
}

function captureScreenshot() {
    const link = document.createElement('a');
    link.download = '3d_analysis_screenshot.png';
    link.href = renderer.domElement.toDataURL();
    link.click();
}

function applyCurrentMatch() {
    if (confirm('ç¡®å®šè¦åº”ç”¨å½“å‰åŒ¹é…æ–¹æ¡ˆå—ï¼Ÿ')) {
        alert('åŒ¹é…æ–¹æ¡ˆå·²åº”ç”¨ï¼');
        // è¿™é‡Œå¯ä»¥è°ƒç”¨APIä¿å­˜æ–¹æ¡ˆ
    }
}

function exportAnalysis() {
    // å¯¼å‡ºåˆ†ææ•°æ®
    const data = {
        shoe: '{{ shoe_model.filename }}',
        blank: document.getElementById('current-blank-name').textContent,
        utilization: document.getElementById('utilization-value').textContent,
        margin: document.getElementById('avg-margin-value').textContent,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.download = 'analysis_report.json';
    link.href = URL.createObjectURL(blob);
    link.click();
}

function saveAnalysis() {
    alert('åˆ†ææ–¹æ¡ˆå·²ä¿å­˜ï¼');
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–3Dåœºæ™¯
    setTimeout(() => {
        init3DScene();
    }, 500);
    
    // çª—å£å¤§å°è°ƒæ•´
    window.addEventListener('resize', function() {
        if (camera && renderer) {
            const container = document.getElementById('viewer-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
    });
    
    // åŠ è½½åˆå§‹åˆ†ææ•°æ®
    {% if optimal_match %}
    loadAnalysisData({{ shoe_model.id }}, {{ optimal_match.blank_model.id }});
    {% endif %}
});
</script>
{% endblock %}
