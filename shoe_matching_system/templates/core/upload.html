{% extends 'base.html' %}
{% load static %}

{% block title %}æ–‡ä»¶ä¸Šä¼  - 3Dé‹æ¨¡åŒ¹é…ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.upload-container {
    max-width: 800px;
    margin: 0 auto;
}

.file-drop-zone {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.file-drop-zone:hover {
    border-color: #007bff;
    background: #e3f2fd;
}

.file-drop-zone.dragover {
    border-color: #28a745;
    background: #d4edda;
}

.file-info {
    font-size: 14px;
    color: #6c757d;
    margin-top: 10px;
}

.file-list {
    margin-top: 15px;
}

.file-item {
    background: #f8f9fa;
    border-radius: 5px;
    padding: 10px 15px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.file-item .file-name {
    font-weight: 500;
}

.file-item .file-size {
    font-size: 12px;
    color: #6c757d;
}

.progress-bar-container {
    width: 100%;
    background: #e9ecef;
    border-radius: 10px;
    height: 8px;
    margin-top: 10px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(45deg, #007bff, #0056b3);
    width: 0%;
    transition: width 0.3s ease;
}

.upload-stats {
    background: linear-gradient(45deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
}

.btn-upload {
    background: linear-gradient(45deg, #28a745, #20a83a);
    border: none;
    padding: 12px 30px;
    font-weight: bold;
    border-radius: 25px;
    min-width: 120px;
}
</style>
{% endblock %}

{% block content %}
<div class="container upload-container mt-4">
    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-cloud-upload-alt text-primary"></i> æ–‡ä»¶ä¸Šä¼ </h2>
                    <p class="text-muted mb-0">ä¸Šä¼ æ‚¨çš„é‹æ¨¡å’Œç²—èƒšæ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æå’ŒåŒ¹é…</p>
                </div>
                <div>
                    <a href="{% url 'core:file_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i> æŸ¥çœ‹æ–‡ä»¶
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ ç»Ÿè®¡ -->
    <div class="upload-stats">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="stat-item">
                    <h4 class="text-primary mb-1">{{ stats.shoe_models }}</h4>
                    <small class="text-muted">é‹æ¨¡æ–‡ä»¶</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <h4 class="text-success mb-1">{{ stats.blank_models }}</h4>
                    <small class="text-muted">ç²—èƒšæ–‡ä»¶</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <h4 class="text-info mb-1">{{ stats.total_matches }}</h4>
                    <small class="text-muted">åŒ¹é…ç»“æœ</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <h4 class="text-warning mb-1">{{ stats.avg_utilization|floatformat:1 }}%</h4>
                    <small class="text-muted">å¹³å‡åˆ©ç”¨ç‡</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ è¡¨å• -->
    <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- é‹æ¨¡æ–‡ä»¶ä¸Šä¼  -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-shoe-prints"></i> é‹æ¨¡æ–‡ä»¶</h5>
                    </div>
                    <div class="card-body">
                        <div class="file-drop-zone" data-target="shoe_files">
                            <div class="drop-icon">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            </div>
                            <h6>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h6>
                            <div class="file-info">
                                æ”¯æŒ .3dm å’Œ .MOD æ ¼å¼<br>
                                æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                            </div>
                        </div>
                        {{ form.shoe_files }}
                        <div class="file-list" id="shoe_files_list"></div>
                    </div>
                </div>
            </div>

            <!-- ç²—èƒšæ–‡ä»¶ä¸Šä¼  -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-cube"></i> ç²—èƒšæ–‡ä»¶</h5>
                    </div>
                    <div class="card-body">
                        <div class="file-drop-zone" data-target="blank_files">
                            <div class="drop-icon">
                                <i class="fas fa-cloud-upload-alt fa-3x text-success mb-3"></i>
                            </div>
                            <h6>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h6>
                            <div class="file-info">
                                æ”¯æŒ .3dm å’Œ .MOD æ ¼å¼<br>
                                æœ€å¤§æ–‡ä»¶å¤§å°: 100MB
                            </div>
                        </div>
                        {{ form.blank_files }}
                        <div class="file-list" id="blank_files_list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸Šä¼ é€‰é¡¹ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cog"></i> å¤„ç†é€‰é¡¹</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {{ form.margin_distance.label_tag }}
                        {{ form.margin_distance }}
                        <small class="form-text text-muted">{{ form.margin_distance.help_text }}</small>
                    </div>
                    <div class="col-md-6">
                        <div class="custom-control custom-checkbox mt-4">
                            {{ form.auto_process }}
                            {{ form.auto_process.label_tag }}
                            <small class="form-text text-muted">{{ form.auto_process.help_text }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æäº¤æŒ‰é’® -->
        <div class="text-center mb-4">
            <button type="submit" class="btn btn-upload btn-lg" id="uploadBtn" disabled>
                <i class="fas fa-upload"></i> å¼€å§‹ä¸Šä¼ 
            </button>
            <div class="progress-bar-container mt-3" id="uploadProgress" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </form>

    <!-- ä¸Šä¼ è¯´æ˜ -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> ä¸Šä¼ è¯´æ˜</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ğŸ“ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼</h6>
                            <ul class="mb-3">
                                <li><strong>.3dm</strong> - Rhinoceros 3D æ¨¡å‹æ–‡ä»¶</li>
                                <li><strong>.MOD</strong> - CAD æ¨¡å‹æ–‡ä»¶</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>âš¡ å¤„ç†æµç¨‹</h6>
                            <ul class="mb-3">
                                <li>æ–‡ä»¶æ ¼å¼éªŒè¯å’Œå¤§å°æ£€æŸ¥</li>
                                <li>3Dæ¨¡å‹æ•°æ®è§£æå’Œåˆ†æ</li>
                                <li>å‡ ä½•ç‰¹å¾æå–å’Œè®¡ç®—</li>
                                <li>è‡ªåŠ¨åŒ¹é…åˆ†æï¼ˆå¯é€‰ï¼‰</li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <strong><i class="fas fa-exclamation-triangle"></i> æ³¨æ„äº‹é¡¹ï¼š</strong>
                        ä¸Šä¼ çš„æ–‡ä»¶å°†è¢«è‡ªåŠ¨åˆ†æï¼Œå¤§æ–‡ä»¶å¯èƒ½éœ€è¦è¾ƒé•¿å¤„ç†æ—¶é—´ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ä¸”æ•°æ®å®Œæ•´ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // æ–‡ä»¶é€‰æ‹©å’Œæ‹–æ‹½åŠŸèƒ½
    initFileDropZones();
    
    // è¡¨å•éªŒè¯
    initFormValidation();
    
    // ä¸Šä¼ è¿›åº¦
    initUploadProgress();
});

function initFileDropZones() {
    $('.file-drop-zone').each(function() {
        const $dropZone = $(this);
        const target = $dropZone.data('target');
        const $fileInput = $(`#id_${target}`);
        const $fileList = $(`#${target}_list`);
        
        // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
        $dropZone.on('click', function() {
            $fileInput.click();
        });
        
        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        $fileInput.on('change', function() {
            updateFileList(this.files, $fileList, target);
            updateUploadButton();
        });
        
        // æ‹–æ‹½äº‹ä»¶
        $dropZone.on('dragover dragenter', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $dropZone.addClass('dragover');
        });
        
        $dropZone.on('dragleave drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $dropZone.removeClass('dragover');
            
            if (e.type === 'drop') {
                const files = e.originalEvent.dataTransfer.files;
                $fileInput[0].files = files;
                updateFileList(files, $fileList, target);
                updateUploadButton();
            }
        });
    });
}

function updateFileList(files, $fileList, target) {
    $fileList.empty();
    
    if (files.length === 0) return;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileSize = formatFileSize(file.size);
        const isValid = validateFile(file);
        
        const $fileItem = $(`
            <div class="file-item ${isValid ? 'border-success' : 'border-danger'}">
                <div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
                <div>
                    ${isValid ? 
                        '<i class="fas fa-check-circle text-success"></i>' : 
                        '<i class="fas fa-exclamation-triangle text-danger"></i>'
                    }
                </div>
            </div>
        `);
        
        $fileList.append($fileItem);
    }
}

function validateFile(file) {
    const validExtensions = ['.3dm', '.mod', '.MOD'];
    const maxSize = 100 * 1024 * 1024; // 100MB
    
    const extension = '.' + file.name.split('.').pop();
    return validExtensions.includes(extension) && file.size <= maxSize;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function updateUploadButton() {
    const shoeFiles = $('#id_shoe_files')[0].files;
    const blankFiles = $('#id_blank_files')[0].files;
    const hasFiles = shoeFiles.length > 0 || blankFiles.length > 0;
    
    $('#uploadBtn').prop('disabled', !hasFiles);
}

function initFormValidation() {
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        const shoeFiles = $('#id_shoe_files')[0].files;
        const blankFiles = $('#id_blank_files')[0].files;
        
        // éªŒè¯æ–‡ä»¶
        let isValid = true;
        const allFiles = [...shoeFiles, ...blankFiles];
        
        for (let file of allFiles) {
            if (!validateFile(file)) {
                isValid = false;
                break;
            }
        }
        
        if (!isValid) {
            showMessage('è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œå¤§å°', 'error');
            return;
        }
        
        if (allFiles.length === 0) {
            showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'warning');
            return;
        }
        
        // å¼€å§‹ä¸Šä¼ 
        startUpload();
    });
}

function initUploadProgress() {
    // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨AJAXä¸Šä¼ ï¼‰
    window.startUpload = function() {
        $('#uploadBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ä¸Šä¼ ä¸­...');
        $('#uploadProgress').show();
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 100) progress = 100;
            
            $('#progressBar').css('width', progress + '%');
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    // æäº¤è¡¨å•
                    $('#uploadForm')[0].submit();
                }, 500);
            }
        }, 200);
    };
}

function showMessage(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const $alert = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `);
    
    $('.upload-container').prepend($alert);
    
    setTimeout(() => {
        $alert.alert('close');
    }, 5000);
}
</script>
{% endblock %}
