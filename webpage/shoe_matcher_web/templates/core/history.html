{% extends 'base.html' %}
{% load static %}

{% block title %}历史记录 - 3D鞋模智能匹配系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>匹配历史记录
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" id="filter-btn">
                        <i class="fas fa-filter me-1"></i>筛选
                    </button>
                    <button class="btn btn-outline-success btn-sm" id="export-history-btn">
                        <i class="fas fa-download me-1"></i>导出
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- 筛选面板 -->
                <div class="collapse mb-3" id="filter-panel">
                    <div class="card card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="status-filter" class="form-label">状态</label>
                                <select class="form-select" id="status-filter">
                                    <option value="">全部状态</option>
                                    <option value="completed">已完成</option>
                                    <option value="processing">处理中</option>
                                    <option value="failed">失败</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date-from" class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="date-from">
                            </div>
                            <div class="col-md-3">
                                <label for="date-to" class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="date-to">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="apply-filter">
                                    <i class="fas fa-search me-1"></i>应用筛选
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 历史记录表格 -->
                <div class="table-responsive">
                    <table class="table table-hover" id="history-table">
                        <thead>
                            <tr>
                                <th>任务ID</th>
                                <th>鞋模名称</th>
                                <th>创建时间</th>
                                <th>状态</th>
                                <th>候选数量</th>
                                <th>通过数量</th>
                                <th>最佳匹配</th>
                                <th>处理时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <nav aria-label="历史记录分页">
                    <ul class="pagination justify-content-center" id="history-pagination">
                        <!-- 分页将通过JavaScript动态生成 -->
                    </ul>
                </nav>
                
                <!-- 加载状态 -->
                <div id="history-loading" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <h6 class="text-muted">正在加载历史记录...</h6>
                </div>
                
                <!-- 空状态 -->
                <div id="history-empty" class="text-center py-5 d-none">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">暂无历史记录</h5>
                    <p class="text-muted">开始您的第一次匹配吧！</p>
                    <a href="{% url 'core:matching' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>开始匹配
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务详情Modal -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailModalLabel">
                    <i class="fas fa-info-circle me-2"></i>任务详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <!-- 任务基本信息 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">基本信息</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr><td>任务ID:</td><td id="detail-task-id">--</td></tr>
                                    <tr><td>鞋模:</td><td id="detail-shoe-name">--</td></tr>
                                    <tr><td>创建时间:</td><td id="detail-created">--</td></tr>
                                    <tr><td>完成时间:</td><td id="detail-completed">--</td></tr>
                                    <tr><td>处理时间:</td><td id="detail-duration">--</td></tr>
                                    <tr><td>状态:</td><td id="detail-status">--</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 匹配参数 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">匹配参数</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr><td>间隙要求:</td><td id="detail-clearance">--</td></tr>
                                    <tr><td>通过标准:</td><td id="detail-threshold">--</td></tr>
                                    <tr><td>自适应缩放:</td><td id="detail-scaling">--</td></tr>
                                    <tr><td>多起点对齐:</td><td id="detail-multistart">--</td></tr>
                                    <tr><td>最大缩放:</td><td id="detail-maxscale">--</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- 匹配结果汇总 -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">结果汇总</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border rounded p-3">
                                            <h4 class="text-primary mb-1" id="detail-total">--</h4>
                                            <small class="text-muted">总候选数</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3">
                                            <h4 class="text-success mb-1" id="detail-passed">--</h4>
                                            <small class="text-muted">通过数量</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>通过率统计</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" id="pass-rate-bar" style="width: 0%"></div>
                                    </div>
                                    <div class="row small">
                                        <div class="col-3">严格: <span id="detail-strict">0</span></div>
                                        <div class="col-3">P10: <span id="detail-p10">0</span></div>
                                        <div class="col-3">P15: <span id="detail-p15">0</span></div>
                                        <div class="col-3">P20: <span id="detail-p20">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 最佳匹配 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">最佳匹配</h6>
                            </div>
                            <div class="card-body">
                                <div id="best-match-info">
                                    <p class="text-muted">暂无数据</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="view-full-results">
                    <i class="fas fa-external-link-alt me-2"></i>查看完整结果
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/history.js' %}"></script>
{% endblock %}
