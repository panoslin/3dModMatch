# 3DMæ–‡ä»¶æ•°æ®ç»“æ„åˆ†æ

## ğŸ” ä»3DMæ–‡ä»¶ä¸­è¯»å–çš„æ•°æ®

### 1. æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
- **æ–‡ä»¶æ ¼å¼**: Rhino 3DM (OpenNURBSæ ¼å¼)
- **å¯¹è±¡æ•°é‡**: é€šå¸¸ä¸º1ä¸ªä¸»è¦å‡ ä½•å¯¹è±¡
- **å›¾å±‚æ•°é‡**: 1ä¸ªé»˜è®¤å›¾å±‚
- **æè´¨æ•°é‡**: é€šå¸¸ä¸º0ï¼ˆæ— æè´¨ä¿¡æ¯ï¼‰

### 2. å‡ ä½•å¯¹è±¡ä¿¡æ¯
æ¯ä¸ª3DMæ–‡ä»¶åŒ…å«ä¸€ä¸ªä¸»è¦çš„å‡ ä½•å¯¹è±¡ï¼š
- **å‡ ä½•ç±»å‹**: `Mesh` (ç½‘æ ¼å¯¹è±¡)
- **å¯¹è±¡ID**: å”¯ä¸€æ ‡è¯†ç¬¦ (UUIDæ ¼å¼)
- **å›¾å±‚ç´¢å¼•**: å¯¹è±¡æ‰€å±å›¾å±‚

### 3. ç½‘æ ¼æ•°æ®ç»“æ„

#### 3.1 é¡¶ç‚¹æ•°æ® (Vertices)
```python
# é¡¶ç‚¹æ•°ç»„å½¢çŠ¶: (N, 3)
# æ•°æ®ç±»å‹: float64
# å†…å­˜å ç”¨: N * 3 * 8 bytes

vertices = np.array([
    [x1, y1, z1],  # é¡¶ç‚¹1çš„3Dåæ ‡
    [x2, y2, z2],  # é¡¶ç‚¹2çš„3Dåæ ‡
    ...
    [xN, yN, zN]   # é¡¶ç‚¹Nçš„3Dåæ ‡
], dtype=np.float64)
```

**å®é™…æ•°æ®ç¤ºä¾‹** (36å°.3dm):
- **é¡¶ç‚¹æ•°**: 631,095ä¸ª
- **åæ ‡èŒƒå›´**:
  - X: [-136.265, 128.025] mm
  - Y: [-43.804, 68.249] mm  
  - Z: [-38.157, 47.116] mm
- **å†…å­˜å ç”¨**: 14.44 MB

#### 3.2 é¢æ•°æ® (Faces)
```python
# é¢æ•°ç»„å½¢çŠ¶: (M, 3)
# æ•°æ®ç±»å‹: int32
# æ¯ä¸ªé¢ç”±3ä¸ªé¡¶ç‚¹ç´¢å¼•ç»„æˆ

faces = np.array([
    [v1, v2, v3],  # ä¸‰è§’å½¢é¢1
    [v4, v5, v6],  # ä¸‰è§’å½¢é¢2
    ...
    [vM, vM+1, vM+2]  # ä¸‰è§’å½¢é¢M
], dtype=np.int32)
```

**å®é™…æ•°æ®ç¤ºä¾‹** (36å°.3dm):
- **é¢æ•°**: 210,365ä¸ªä¸‰è§’å½¢
- **é¢ç´¢å¼•èŒƒå›´**: [0, 631094]
- **å¹³å‡æ¯é¢é¡¶ç‚¹æ•°**: 0.33 (ä¸‰è§’å½¢ç½‘æ ¼)

### 4. å‡ ä½•ç‰¹å¾

#### 4.1 è¾¹ç•Œæ¡† (Bounding Box)
```python
bbox_min = vertices.min(axis=0)  # æœ€å°åæ ‡
bbox_max = vertices.max(axis=0)  # æœ€å¤§åæ ‡
bbox_size = bbox_max - bbox_min  # å°ºå¯¸
```

**å®é™…æ•°æ®ç¤ºä¾‹** (36å°.3dm):
- **å®½åº¦**: 264.289 mm
- **æ·±åº¦**: 112.053 mm
- **é«˜åº¦**: 85.273 mm

#### 4.2 ä½“ç§¯è®¡ç®—
ä½¿ç”¨C++æ¨¡å—è®¡ç®—ç²¾ç¡®ä½“ç§¯ï¼š
```python
volume = cppcore.coarse_features(vertices, faces)['volume']
```

**å®é™…æ•°æ®ç¤ºä¾‹**:
- **ç›®æ ‡æ¨¡å‹** (36å°.3dm): 631,470 mmÂ³
- **å€™é€‰æ¨¡å‹** (002å°.3dm): 1,065,934 mmÂ³ (1.69å€)

#### 4.3 ä¸­å¿ƒç‚¹
```python
center = vertices.mean(axis=0)
```

**å®é™…æ•°æ®ç¤ºä¾‹** (36å°.3dm):
- **ä¸­å¿ƒç‚¹**: (-7.005, 1.659, 1.135) mm

### 5. æ•°æ®è½¬æ¢è¿‡ç¨‹

#### 5.1 3DMæ–‡ä»¶è¯»å–
```python
# 1. è¯»å–3DMæ–‡ä»¶
m = rhino3dm.File3dm.Read(file_path)

# 2. éå†æ‰€æœ‰å¯¹è±¡
for obj in m.Objects:
    g = obj.Geometry
    
    # 3. è·å–ç½‘æ ¼æ•°æ®
    if isinstance(g, rhino3dm.Mesh):
        mesh = g
    elif hasattr(g, 'GetMesh'):
        mesh = g.GetMesh(rhino3dm.MeshType.Default)
    
    # 4. ä»BREPè‡ªåŠ¨ç”Ÿæˆç½‘æ ¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if mesh is None and isinstance(g, rhino3dm.Brep):
        meshes = rhino3dm.Mesh.CreateFromBrep(g, meshing_params)
        mesh = combine_meshes(meshes)
```

#### 5.2 é¡¶ç‚¹æ•°æ®æå–
```python
# æå–é¡¶ç‚¹åæ ‡
vertices = np.array([
    [v.X, v.Y, v.Z] for v in mesh.Vertices
], dtype=np.float64)
```

#### 5.3 é¢æ•°æ®æå–
```python
# æå–é¢ç´¢å¼•
faces = []
for f in mesh.Faces:
    if hasattr(f, 'A'):
        # ä¸‰è§’å½¢é¢
        a, b, c = f.A, f.B, f.C
        faces.append([a, b, c])
        
        # å››è¾¹å½¢é¢åˆ†è§£ä¸ºä¸¤ä¸ªä¸‰è§’å½¢
        d = getattr(f, 'D', None)
        if d is not None and d not in (c, -1):
            faces.append([a, c, d])
    else:
        # å…¶ä»–æ ¼å¼
        a, b, c = f[0], f[1], f[2]
        faces.append([a, b, c])
        if len(f) >= 4:
            d = f[3]
            if d != c and d != -1:
                faces.append([a, c, d])

faces = np.asarray(faces, dtype=np.int32)
```

### 6. æ•°æ®è´¨é‡ç‰¹å¾

#### 6.1 ç½‘æ ¼è´¨é‡
- **ä¸‰è§’å½¢ç½‘æ ¼**: æ‰€æœ‰é¢éƒ½æ˜¯ä¸‰è§’å½¢
- **æ— é‡å¤é¡¶ç‚¹**: æ¯ä¸ªé¡¶ç‚¹åªå­˜å‚¨ä¸€æ¬¡
- **é¢ç´¢å¼•æ­£ç¡®**: æ‰€æœ‰é¢ç´¢å¼•éƒ½åœ¨æœ‰æ•ˆèŒƒå›´å†…
- **æ— å­¤ç«‹é¡¶ç‚¹**: æ‰€æœ‰é¡¶ç‚¹éƒ½è¢«è‡³å°‘ä¸€ä¸ªé¢å¼•ç”¨

#### 6.2 å‡ ä½•ç²¾åº¦
- **åæ ‡ç²¾åº¦**: float64 (åŒç²¾åº¦æµ®ç‚¹æ•°)
- **å•ä½**: æ¯«ç±³ (mm)
- **ç²¾åº¦**: å°æ•°ç‚¹å3ä½æœ‰æ•ˆæ•°å­—

#### 6.3 æ•°æ®å®Œæ•´æ€§
- **é¡¶ç‚¹-é¢ä¸€è‡´æ€§**: é¢ç´¢å¼•ä¸é¡¶ç‚¹æ•°é‡åŒ¹é…
- **å‡ ä½•é—­åˆæ€§**: ç½‘æ ¼å½¢æˆå°é—­çš„3Dè¡¨é¢
- **æ³•å‘é‡**: é€šè¿‡é¢æ•°æ®è®¡ç®—è¡¨é¢æ³•å‘é‡

### 7. å®é™…åº”ç”¨ä¸­çš„æ•°æ®æµ

#### 7.1 åŠ è½½é˜¶æ®µ
```python
# 1. è¯»å–3DMæ–‡ä»¶
V, F = load_3dm_enhanced(file_path, mesh_quality='high')

# 2. æ•°æ®éªŒè¯
assert V.shape[1] == 3, "é¡¶ç‚¹å¿…é¡»æ˜¯3Dåæ ‡"
assert F.max() < len(V), "é¢ç´¢å¼•è¶…å‡ºèŒƒå›´"
assert F.min() >= 0, "é¢ç´¢å¼•ä¸èƒ½ä¸ºè´Ÿæ•°"
```

#### 7.2 é¢„å¤„ç†é˜¶æ®µ
```python
# 1. ç½‘æ ¼é¢„å¤„ç†
V, F = preprocess_mesh(V, F, 
    fix_normals=True,
    fill_holes=True,
    remove_duplicates=True
)

# 2. ç‰¹å¾è®¡ç®—
features = cppcore.coarse_features(V, F)
volume = features['volume']
center = V.mean(axis=0)
```

#### 7.3 åŒ¹é…é˜¶æ®µ
```python
# 1. å‡ ä½•å¯¹é½
aligned_V = align_geometry(V_candidate, F_candidate, V_target, F_target)

# 2. è·ç¦»è®¡ç®—
distances = compute_clearance_distances(V_target, F_target, aligned_V, F_candidate)

# 3. ç»Ÿè®¡åˆ†æ
min_dist = distances.min()
p15_dist = np.percentile(distances, 15)
mean_dist = distances.mean()
```

### 8. æ•°æ®å­˜å‚¨æ ¼å¼

#### 8.1 å†…å­˜ä¸­çš„è¡¨ç¤º
```python
# é¡¶ç‚¹æ•°ç»„: (N, 3) float64
vertices = np.array([[x, y, z], ...], dtype=np.float64)

# é¢æ•°ç»„: (M, 3) int32  
faces = np.array([[i, j, k], ...], dtype=np.int32)
```

#### 8.2 æ–‡ä»¶ä¸­çš„è¡¨ç¤º
- **3DMæ ¼å¼**: RhinoåŸç”Ÿæ ¼å¼ï¼ŒåŒ…å«å®Œæ•´å‡ ä½•ä¿¡æ¯
- **PLYæ ¼å¼**: å¯¼å‡ºæ ¼å¼ï¼ŒåŒ…å«é¡¶ç‚¹å’Œé¢æ•°æ®
- **STLæ ¼å¼**: æ ‡å‡†ä¸‰è§’ç½‘æ ¼æ ¼å¼

### 9. æ€§èƒ½ç‰¹å¾

#### 9.1 å†…å­˜ä½¿ç”¨
- **é¡¶ç‚¹æ•°æ®**: N Ã— 3 Ã— 8 bytes (float64)
- **é¢æ•°æ®**: M Ã— 3 Ã— 4 bytes (int32)
- **æ€»å†…å­˜**: N Ã— 24 + M Ã— 12 bytes

#### 9.2 å¤„ç†æ—¶é—´
- **æ–‡ä»¶è¯»å–**: ~100ms (631Ké¡¶ç‚¹)
- **ç½‘æ ¼é¢„å¤„ç†**: ~500ms
- **ç‰¹å¾è®¡ç®—**: ~200ms
- **å‡ ä½•å¯¹é½**: ~2-5ç§’

### 10. æ•°æ®éªŒè¯

#### 10.1 å®Œæ•´æ€§æ£€æŸ¥
```python
# æ£€æŸ¥é¡¶ç‚¹-é¢ä¸€è‡´æ€§
assert F.max() < len(V), "é¢ç´¢å¼•è¶…å‡ºé¡¶ç‚¹èŒƒå›´"
assert F.min() >= 0, "é¢ç´¢å¼•ä¸èƒ½ä¸ºè´Ÿæ•°"

# æ£€æŸ¥ç½‘æ ¼è´¨é‡
assert len(V) > 0, "é¡¶ç‚¹æ•°é‡å¿…é¡»å¤§äº0"
assert len(F) > 0, "é¢æ•°é‡å¿…é¡»å¤§äº0"
assert F.shape[1] == 3, "é¢å¿…é¡»æ˜¯ä¸‰è§’å½¢"
```

#### 10.2 å‡ ä½•åˆç†æ€§
```python
# æ£€æŸ¥è¾¹ç•Œæ¡†åˆç†æ€§
bbox_size = V.max(axis=0) - V.min(axis=0)
assert bbox_size.min() > 0, "è¾¹ç•Œæ¡†å°ºå¯¸å¿…é¡»ä¸ºæ­£"
assert bbox_size.max() < 1000, "æ¨¡å‹å°ºå¯¸è¿‡å¤§"

# æ£€æŸ¥ä½“ç§¯åˆç†æ€§
volume = cppcore.coarse_features(V, F)['volume']
assert volume > 0, "ä½“ç§¯å¿…é¡»ä¸ºæ­£"
assert volume < 1e9, "ä½“ç§¯è¿‡å¤§"
```

## ğŸ“Š æ€»ç»“

ä»3DMæ–‡ä»¶ä¸­è¯»å–çš„æ•°æ®ä¸»è¦åŒ…æ‹¬ï¼š

1. **é¡¶ç‚¹æ•°æ®**: 3Dåæ ‡æ•°ç»„ (NÃ—3 float64)
2. **é¢æ•°æ®**: ä¸‰è§’å½¢ç´¢å¼•æ•°ç»„ (MÃ—3 int32)
3. **å‡ ä½•ç‰¹å¾**: ä½“ç§¯ã€è¾¹ç•Œæ¡†ã€ä¸­å¿ƒç‚¹ç­‰
4. **å…ƒæ•°æ®**: å¯¹è±¡IDã€å›¾å±‚ä¿¡æ¯ç­‰

è¿™äº›æ•°æ®ç»è¿‡é¢„å¤„ç†åï¼Œç”¨äº3Då‡ ä½•åŒ¹é…ç®—æ³•ï¼Œå®ç°é‹æ¨¡çš„æ™ºèƒ½åŒ¹é…åŠŸèƒ½ã€‚
